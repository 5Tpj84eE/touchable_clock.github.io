<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>さわれる時計</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #F2F2F2;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }
    .container {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      box-sizing: border-box;
    }
    #clockCanvas {
      display: block;
      max-width: 100vw;
      max-height: 75vh;
      touch-action: none;
    }
    #digitalClock {
      margin-top: 8px;
      font-size: 3em;
      text-align: center;
    }
    .hour {
      color: #C62828;
    }
    .minute {
      color: #1565C0;
    }
    #resetBtn {
      margin-top: 10px;
      font-size: 3.0em;
      padding: 6px 24px;
      border: none;
      border-radius: 6px;
      background: #1976D2;
      color: white;
      cursor: pointer;
    }
    #resetBtn:active {
      background: #0D47A1;
    }
  </style>
</head>
<body>
  <div class="container">
    <canvas id="clockCanvas"></canvas>
    <div id="digitalClock"></div>
    <button id="resetBtn">現在時刻に合わせる</button>
  </div>

  <script>
    const canvas = document.getElementById("clockCanvas");
    const ctx = canvas.getContext("2d");

    let customTime = null;   // 手動設定中の時間
    let dragging = null;     // "hour" or "minute"
    let lastAngle = null;    // 直前の角度

    function resizeCanvas() {
      const size = Math.min(window.innerWidth, window.innerHeight * 0.75);
      canvas.width = size;
      canvas.height = size;
    }

    function drawClock() {
      resizeCanvas();
      const radius = canvas.height / 2;
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.translate(radius, radius);

      ctx.clearRect(-radius, -radius, canvas.width, canvas.height);
      drawFace(ctx, radius);
      drawNumbers(ctx, radius);

      const now = customTime ? new Date(customTime) : new Date();
      drawTime(ctx, radius, now);
      updateDigitalClock(now);
    }

    function drawFace(ctx, radius) {
      ctx.beginPath();
      ctx.arc(0, 0, radius * 0.95, 0, 2 * Math.PI);
      ctx.fillStyle = "#fff";
      ctx.fill();
    }

    function drawNumbers(ctx, radius) {
      ctx.font = radius * 0.12 + "px Arial";
      ctx.textBaseline = "middle";
      ctx.textAlign = "center";

      // 時（1〜12）
      ctx.fillStyle = "#C62828";
      for (let num = 1; num <= 12; num++) {
        let angle = (num * Math.PI) / 6;
        let x = radius * 0.75 * Math.sin(angle);
        let y = -radius * 0.75 * Math.cos(angle);
        ctx.fillText(num.toString(), x, y);
      }

      // 分（0〜59）
      ctx.font = radius * 0.06 + "px Arial";
      ctx.fillStyle = "#1565C0";
      for (let num = 0; num < 60; num++) {
        let angle = (num * Math.PI) / 30;
        let x = radius * 0.9 * Math.sin(angle);
        let y = -radius * 0.9 * Math.cos(angle);
        ctx.fillText(num.toString(), x, y);
      }
    }

    function drawTime(ctx, radius, now) {
      let hour = now.getHours();
      let minute = now.getMinutes();

      // 時針
      let hourPos = (hour % 12) * Math.PI / 6 + (minute * Math.PI) / (6 * 60);
      drawHand(ctx, hourPos, radius * 0.5, radius * 0.07, "#C62828");

      // 分針
      let minutePos = (minute * Math.PI) / 30;
      drawHand(ctx, minutePos, radius * 0.7, radius * 0.05, "#1565C0");
    }

    function drawHand(ctx, pos, length, width, color) {
      ctx.beginPath();
      ctx.lineWidth = width;
      ctx.lineCap = "round";
      ctx.strokeStyle = color;
      ctx.moveTo(0, 0);
      ctx.lineTo(length * Math.sin(pos), -length * Math.cos(pos));
      ctx.stroke();
    }

    function updateDigitalClock(now) {
      let hour = now.getHours();
      let minute = now.getMinutes();
      let displayHour = hour % 12;
      if (displayHour === 0) displayHour = 12;

      const digital = `
        <span class="hour">${displayHour}<ruby>時<rt>じ</rt></ruby></span>
        <span class="minute">${minute}<ruby>分<rt>ふん</rt></ruby></span>
      `;
      document.getElementById("digitalClock").innerHTML = digital;
    }

    // --- 操作関連 ---
    function getAngle(x, y) {
      return Math.atan2(y, x);
    }

    function handlePointerDown(e) {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left - canvas.width/2;
      const y = e.clientY - rect.top - canvas.height/2;
      const angle = getAngle(x, y);
      const distance = Math.sqrt(x*x + y*y);
      const radius = canvas.width/2;

      const now = customTime ? new Date(customTime) : new Date();
      let hourAngle = ((now.getHours() % 12) + now.getMinutes()/60) * Math.PI/6;
      let minuteAngle = now.getMinutes() * Math.PI/30;

      function angleDiff(a, b) {
        return Math.abs(Math.atan2(Math.sin(a-b), Math.cos(a-b)));
      }

      // 針ごとの距離スコアを計算
      function scoreHand(targetAngle, handLength) {
        const diff = angleDiff(angle, targetAngle);
        const radialDiff = Math.max(0, distance - handLength); // 長さより外なら距離を追加
        return diff * 100 + radialDiff; // 角度を優先しつつ距離も加味
      }

      const hourScore = scoreHand(hourAngle, radius*0.5);
      const minuteScore = scoreHand(minuteAngle, radius*0.7);

      dragging = hourScore < minuteScore ? "hour" : "minute";
      lastAngle = angle;
    }

    function handlePointerMove(e) {
      if (!dragging) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left - canvas.width/2;
      const y = e.clientY - rect.top - canvas.height/2;
      const angle = getAngle(x, y);

      let delta = angle - lastAngle;
      delta = Math.atan2(Math.sin(delta), Math.cos(delta));
      lastAngle = angle;

      const now = customTime ? new Date(customTime) : new Date();

      if (dragging === "hour") {
        // 1周 = 12時間（分も含めて連動）
        let minutesDelta = delta / (2*Math.PI) * 12 * 60;
        now.setMinutes(now.getMinutes() + minutesDelta);
      } else if (dragging === "minute") {
        // 1周 = 60分
        let minutesDelta = delta / (2*Math.PI) * 60;
        now.setMinutes(now.getMinutes() + minutesDelta);
      }

      customTime = now;
      drawClock();
    }

    function handlePointerUp() {
      dragging = null;
      lastAngle = null;
    }

    canvas.addEventListener("mousedown", handlePointerDown);
    canvas.addEventListener("mousemove", handlePointerMove);
    canvas.addEventListener("mouseup", handlePointerUp);

    canvas.addEventListener("touchstart", e => handlePointerDown(e.touches[0]));
    canvas.addEventListener("touchmove", e => {
      handlePointerMove(e.touches[0]);
      e.preventDefault();
    });
    canvas.addEventListener("touchend", handlePointerUp);

    // 現在時刻に戻すボタン
    document.getElementById("resetBtn").addEventListener("click", () => {
      customTime = null;
      drawClock();
    });

    setInterval(() => {
      if (!customTime) drawClock();
    }, 1000);

    drawClock();
    window.addEventListener("resize", drawClock);
  </script>
</body>
</html>
